#!/usr/bin/python
'''Send this the given file to your Wordpress blog as a post.
The filename will be converted into a title. (Dashes become spaces, .txt or .mkd are removed.)

You need to create a file called ~/.edthedev.ini to use this script. Include the following:

[wordpress]
user=<wordpress login name>
password=<wordpress password>
api_url=http://example.com/xmlrpc.php

If you would like to call this script directly while editing a file, see vimrc_edthedev for example usage in .vimrc file.
'''

import xmlrpclib
import ConfigParser
import sys
import os

def titleFromFileName(name, ext='txt'):
  name = os.path.basename(name)
  new_name = name.replace('-', ' ')
  # if not (new_name.endswith('.txt') or new_name.endswith('.pdf')):
  new_name = new_name.replace('.txt', '')
  new_name = new_name.replace('.mkd', '')
  return new_name

if __name__ == '__main__':

  # Get post content
  input_file = sys.argv[1]
  f = open(input_file, 'r')
  content = '\n'.join(f.readlines())
  title = titleFromFileName(input_file)
   
  # Get configuration 
  conf = ConfigParser.ConfigParser()
  wordpress_settings = '~/.edthedev.ini' 
  settings_file = os.path.expanduser(wordpress_settings)
  conf.read(settings_file)
  user = conf.get('wordpress', 'user') 
  passwd = conf.get('wordpress', 'password')
  api_url = conf.get('wordpress', 'api_url') 
  server = xmlrpclib.ServerProxy(api_url)

  # Create post
  blog_id = 0

  blog_content = { 'title' : title, 'description' : content }
  # categories = [{'categoryId' : 'programming', 'isPrimary' : 1}] 
  categories = [{'categoryId' : 'children', 'isPrimary' : 1}] 

  post_id = int(server.metaWeblog.newPost(blog_id, user, passwd, blog_content,0))
  print "Created post id " + str(post_id)
  server.mt.setPostCategories(post_id, user, passwd, categories) # not work
  server.mt.publishPost(post_id, user, passwd)
  print "Post published."
